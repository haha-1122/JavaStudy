# Thread Safety

### 위키 정의

``` 
스레드 안전은 멀티 스레드 프로그래밍에서 일반적으로 어떤 함수나 변수, 혹은 객체가 여러 스레드로부터 동시에 접근이 이루어져도 프로그램의 실행에 문제가 없음을 뜻한다. 보다 엄밀하게는 하나의 함수가 한 스레드로부터 호출되어 실행 중일 때, 다른 스레드가 그 함수를 호출하여 동시에 함께 실행되더라도 각 스레드에서의 함수의 수행 결과가 올바로 나오는 것으로 정의한다.
```

즉 A ,B  쓰레드가 동시에 a 메소드에 접근하더라도, 논리적인 오류를 유발하지 않는 프로그래밍을 Thread Safety라고 한다

### Thread-safety를 구현하는 방법

-   **Re-entrancy** (재진입성)

    컴퓨터 프로그램 또는 서브루틴(메소드)에 Re-Entrancy가 있으면, 이 서브루틴은 동시에(병렬) 안전하게 실행 가능하다. 즉 재진입이 가능한 루틴은 동시에 접근해도 언제나 같은 실행 결과를 보장한다. 재진입이 가능하려면 메소드는 다음 조건을 만족하여야 한다.

    

    -   정적 (전역) 변수를 사용하면 안 된다.
    -   정적 (전역) 변수의 주소를 반환하면 안 된다.
    -   호출자가 호출 시 제공한 매개변수만으로 동작해야 한다.
    -   싱글턴 객체의 잠금에 의존하면 안 된다.
    -   다른 비-재진입 함수를 호출하면 안 된다.

    

    

    정리하자면 *Local Variable(지역변수)*만 사용하라는거다.

    쓰레드는 자원을 공유하기 때문이다.

    예시를 보자.

    ``` java
    int num = 0;
    
    int f() {
        num++;
    }
    
    int g() {
        return f() + 2;
    }
    ```

    위 코드를 보면 f함수는 *Gloval Variable(전역변수)* num에 의존하고 있다. 만약 두 개의 쓰레드가 이 함수를 실행하여 동시에 num에 접근할 경우 실행되는 시점에 따라 결과가 다르게 나타난다

    ``` 
    A -> f() 진입 -> num++를 하기 위해 num 값 참조 -> num = 0 -> (to RUNNABLE)
    B -> f() 진입 -> num++를 하기 위해 num 값 참조 -> num = 0 -> num = 0 + 1 -> (to RUNNABLE)
    A -> num = 0 에서 작업 계속 -> num = 0 + 1
    ```

    이렇게 두 쓰레드가 저렇게 간단한 연산을 수행하는데에도 오류가 난다. ++ 같은 경우라 해도

    값을 참조 -> 값의 변경 이렇게 두 단계로 이루어져 있기 때문이다.

    실제로 저 함수를 멀티 쓰레드로 반복문을 돌릴경우 논리적인 오류가 발생한다.

    

    ``` java
    int f(int i) {
        int num = i;
        num++;
        return num;
    }
    
    int g(int i) {
        int num = i;
        return f(i)++;
    }
    ```

    위의 경우 Re-entrancy를 만족한다.

    

    

    ### Mutual Exclusion, Mutex (상호 배제)

    java에서 syncronized 같은 키워드를 사용해 동시에 접근할 수 없게 lock을 걸어버리는 방법이다. 임계 구역(critical section) 이라고도 한다.

    또한 Mutex는 교착상태(DeadLock)의 4가지 필요조건중 하나이기도 하다.

    

    ### Thread-local Storage 

    공유 자원의 사용을 최대한 줄여 각각의 쓰레드에서만 접근 가능한 저장소들을 사용하여 동시 접근을 막는 방법이다.

    

    ### Atomic Operations

    공유 자원에 접근할 때 원자 연산을 이용하거나 '원자적'으로 정의된 접근 방법을 사용함으로써 상호 배제를 구현할 수 있다. (i++도 원자적으로 보면 단원자 연산은 아니다.)

